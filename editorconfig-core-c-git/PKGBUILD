# Original Author: Erik van der Kolk <developer at smerik dot nl>
# Maintainer: Hong Xu <hong@topbug.net>
pkgname=editorconfig-core-c-git
pkgver=20140816
pkgrel=1
pkgdesc="EditorConfig core code written in C (for use by plugins supporting EditorConfig parsing)"
arch=('i686' 'x86_64')
url="https://github.com/editorconfig/editorconfig-core-c"
license=('BSD')
depends=('pcre')
makedepends=('git' 'cmake>=2.6')
provides=('editorconfig-core' 'editorconfig-core-c')
conflicts=('editorconfig-core' 'editorconfig-core-c')
md5sums=('SKIP')

_gitroot="git://github.com/editorconfig"
_gitname="editorconfig-core-c"

build() {
  cd "${srcdir}"

  msg "Checking for local Git repository..."
  if [[ -d "${srcdir}/${_gitname}" ]] ; then
    msg "Local repository found: let's fetch & merge from remote..."
    cd "${_gitname}"
    git pull origin --recurse-submodules
  else
    msg "No local repository found: start cloning remote..."
    git clone "${_gitroot}/${_gitname}.git" --recurse-submodules
  fi
  msg "Git workout done."

  cd "${srcdir}/${_gitname}"

  msg "Starting make..."
  cmake -D CMAKE_INSTALL_PREFIX=/usr .
  make
}

check() {
  cd "${srcdir}/${_gitname}"
  make test
}

package() {
  cd "${srcdir}/${_gitname}"
  make DESTDIR="${pkgdir}" install

  msg "Including license..."
  install -v -D -m 644 "${srcdir}/${_gitname}/LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
